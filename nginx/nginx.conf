# Configuración principal de Nginx para el Gym Microservices

# Configuración de eventos - maneja las conexiones
events {
    worker_connections 1024;  # Máximo 1024 conexiones simultáneas por worker
}

# Configuración HTTP principal
http {
    # Configuración básica de logs
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
    
    # Configuraciones de rendimiento
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    
    # Definir upstream (grupos de servidores backend) para balanceador de carga
    # Cada upstream representa un microservicio
    
    # Grupo de servidores para User Service
    upstream user_service_backend {
        # Solo un servidor por ahora (no hay réplicas)
        server user_service:3003;
        # Si tuvieras réplicas, podrías agregar más líneas como:
        # server user_service_2:3003;
        # server user_service_3:3003;
    }
    
    # Grupo de servidores para Membership Service
    upstream membership_service_backend {
        server membership_service:3002;
    }
    
    # Grupo de servidores para Routine Service  
    upstream routine_service_backend {
        server routine_service:4002;
    }
    
    # Configuración del servidor principal (proxy reverso)
    server {
        listen 80;  # Nginx escucha en el puerto 80
        server_name localhost;  # Nombre del servidor
        
        # Configuración de headers para el proxy
        # Estos headers preservan información importante de la petición original
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # RUTA 1: Redirigir peticiones de users al User Service
        location /api/users/ {
            # El proxy reverso redirige al upstream definido arriba
            proxy_pass http://user_service_backend/api/users/;
            
            # Configuraciones adicionales del proxy
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }
        
        # RUTA 2: Redirigir peticiones de memberships al Membership Service
        location /api/memberships/ {
            proxy_pass http://membership_service_backend/api/memberships/;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }
        
        # RUTA 3: Health check específico de memberships
        location /api/health {
            proxy_pass http://membership_service_backend/api/health;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }
        
        # RUTA 4: Redirigir peticiones de rutinas al Routine Service
        location /api/routines/ {
            proxy_pass http://routine_service_backend/api/routines/;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }
        
        # RUTA 5: Redirigir peticiones de ejercicios al Routine Service
        location /api/exercises/ {
            proxy_pass http://routine_service_backend/api/exercises/;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }
        
        # RUTA 6: Health check del Routine Service
        location /health {
            proxy_pass http://routine_service_backend/health;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }
        
        # RUTA 7: Endpoint para verificar el estado del balanceador de carga
        location /load-balancer/status {
            # Respuesta directa desde Nginx (no redirige a ningún backend)
            return 200 '{"status": "OK", "service": "nginx-load-balancer", "upstreams": {"user_service": "user_service:3003", "membership_service": "membership_service:3002", "routine_service": "routine_service:4002"}}';
            add_header Content-Type application/json;
        }
        
        # RUTA 8: Ruta por defecto para peticiones no coincidentes
        location / {
            return 404 '{"error": "Endpoint not found", "available_routes": ["/api/users/", "/api/memberships/", "/api/routines/", "/api/exercises/", "/health", "/load-balancer/status"]}';
            add_header Content-Type application/json;
        }
        
        # Página de error personalizada
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root /usr/share/nginx/html;
        }
    }
}