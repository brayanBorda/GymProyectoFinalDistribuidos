# Configuración principal de Nginx para el Gym Microservices
# CON BALANCEO DE CARGA - Cada microservicio tiene 2 instancias

# Configuración de eventos - maneja las conexiones
events {
    worker_connections 1024;  # Máximo 1024 conexiones simultáneas por worker
}

# Configuración HTTP principal
http {
    # Configuración básica de logs
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
    
    # Configuraciones de rendimiento
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    
    # Definir upstream (grupos de servidores backend) para balanceador de carga
    # Cada upstream representa un microservicio con sus réplicas
    # Nginx distribuirá las peticiones entre las instancias usando round-robin por defecto
    
    # Grupo de servidores para User Service (2 instancias)
    upstream user_service_backend {
        # Primera instancia de User Service
        server user_service:3003;
        # Segunda instancia de User Service (réplica)
        server user_service_2:3003;
        # Nginx distribuirá las peticiones entre ambas instancias de forma alternada
    }
    
    # Grupo de servidores para Membership Service (2 instancias)
    upstream membership_service_backend {
        # Primera instancia de Membership Service
        server membership_service:3002;
        # Segunda instancia de Membership Service (réplica)
        server membership_service_2:3002;
        # Nginx distribuirá las peticiones entre ambas instancias de forma alternada
    }
    
    # Grupo de servidores para Routine Service (2 instancias)
    upstream routine_service_backend {
        # Primera instancia de Routine Service
        server routine_service:4002;
        # Segunda instancia de Routine Service (réplica)
        server routine_service_2:4002;
        # Nginx distribuirá las peticiones entre ambas instancias de forma alternada
    }
    
    # Configuración del servidor principal (proxy reverso)
    server {
        listen 80;  # Nginx escucha en el puerto 80
        server_name localhost;  # Nombre del servidor
        
        # Configuración de headers para el proxy
        # Estos headers preservan información importante de la petición original
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # RUTA 1: Redirigir peticiones de users al User Service (con balanceo de carga)
        location /api/users/ {
            # El proxy reverso redirige al upstream definido arriba
            # Nginx distribuirá automáticamente entre user_service y user_service_2
            proxy_pass http://user_service_backend/api/users/;
            
            # Configuraciones adicionales del proxy
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }
        
        # RUTA 2: Redirigir peticiones de memberships al Membership Service (con balanceo de carga)
        location /api/memberships/ {
            # Nginx distribuirá automáticamente entre membership_service y membership_service_2
            proxy_pass http://membership_service_backend/api/memberships/;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }
        
        # RUTA 3: Health check específico de memberships (con balanceo de carga)
        location /api/health {
            # Nginx distribuirá automáticamente entre membership_service y membership_service_2
            proxy_pass http://membership_service_backend/api/health;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }
        
        # RUTA 4: Redirigir peticiones de rutinas al Routine Service (con balanceo de carga)
        location /api/routines/ {
            # Nginx distribuirá automáticamente entre routine_service y routine_service_2
            proxy_pass http://routine_service_backend/api/routines/;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }
        
        # RUTA 5: Redirigir peticiones de ejercicios al Routine Service (con balanceo de carga)
        location /api/exercises/ {
            # Nginx distribuirá automáticamente entre routine_service y routine_service_2
            proxy_pass http://routine_service_backend/api/exercises/;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }
        
        # RUTA 6: Health check del Routine Service (con balanceo de carga)
        location /health {
            # Nginx distribuirá automáticamente entre routine_service y routine_service_2
            proxy_pass http://routine_service_backend/health;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }
        
        # RUTA 7: Endpoint para verificar el estado del balanceador de carga
        location /load-balancer/status {
            # Respuesta directa desde Nginx (no redirige a ningún backend)
            return 200 '{"status": "OK", "service": "nginx-load-balancer", "upstreams": {"user_service": ["user_service:3003", "user_service_2:3003"], "membership_service": ["membership_service:3002", "membership_service_2:3002"], "routine_service": ["routine_service:4002", "routine_service_2:4002"]}}';
            add_header Content-Type application/json;
        }
        
        # RUTA 8: Ruta por defecto para peticiones no coincidentes
        location / {
            return 404 '{"error": "Endpoint not found", "available_routes": ["/api/users/", "/api/memberships/", "/api/routines/", "/api/exercises/", "/health", "/load-balancer/status"]}';
            add_header Content-Type application/json;
        }
        
        # Página de error personalizada
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root /usr/share/nginx/html;
        }
    }
}